---
title: "NFL Players & Teams - Stats Dashboard"
author: "Adam White"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
---

```{r, warning=FALSE, echo = FALSE}
library(flexdashboard)
library(nflreadr)
library(ggplot2)
library(nflfastR)
library(dplyr)
library(tidyverse)
library(ggrepel)
library(gt)
library(ggimage)
library(gtExtras)
library(kableExtra)
library(DT)
setwd("/Users/Adam/Sports Analytics Hobby/NFL Analytics/2025 Dashboard/")
```



Running Backs
================================
<style>
/* Change sidebar background color */
.flex-page .sidebar {
  background-color: #5b9452; 
}

/* Change text color in the sidebar */
.flex-page .sidebar, .flex-page .sidebar h1, .flex-page .sidebar h2, .flex-page .sidebar h3 {
  color: #FFFFFF;
}
</style>
## Sidebar {.sidebar data-width=400}
------------------------------------------------------

Column  {.tabset .tabset-fade}
-----------------------------------------------------------------------
### Explosive Play % and EPA/play
```{r}
knitr::include_graphics("exp_play_rbs.png")
```

### Rush Yards over Expected
```{r}
knitr::include_graphics("ryoe_rbs.png")
```

### Fantasy Volatility
```{r}
knitr::include_graphics("fantasy_vars_rbs.png")
```

### Runninng Back Updated Stats
```{r, echo = FALSE}
season_player_stats <- nflreadr::load_player_stats(
  seasons = 2025,
  summary_level = "reg", 
)

rb_season_stats <- season_player_stats %>%
  filter(position == "RB") %>%
  select(player_id,
         player_name,
         player_display_name,
         carries,
         rushing_yards,
         rushing_tds,
         rushing_fumbles,
         rushing_fumbles_lost,
         rushing_first_downs,
         rushing_epa,
         targets,
         receptions,
         receiving_yards,
         receiving_tds,
         receiving_epa,
         fantasy_points_ppr,
         receiving_first_downs
  ) %>%
  mutate(total_epa = receiving_epa + rushing_epa,
         first_downs = rushing_first_downs + receiving_first_downs) %>%
  filter(carries >= 50) %>%
  arrange(-rushing_yards)

rb_season_stats <- rb_season_stats %>%
  select(player_display_name,
         carries,
         rushing_yards,
         rushing_tds,
         rushing_fumbles,
         rushing_fumbles_lost,
         first_downs,
         rushing_epa,
         targets,
         receptions,
         receiving_yards,
         receiving_tds,
         receiving_epa,
         total_epa,
         fantasy_points_ppr)
colnames(rb_season_stats) <- c("Player", "Carries", "Rushing Yards",
                               "Rushing TD", "Fumbles", "Fumbles Lost",
                               "First Downs", "Rushing EPA", "Targets",
                               "Catches", "Receiving Yards", "Receiving TDs",
                               "Receiving EPA", "Total EPA", "PPR Fantasy PTS")

datatable(rb_season_stats, filter = 'top', options = list(pageLength = 25))

```


Receivers (WR, RB, TE)
================================
<style>
/* Change sidebar background color */
.flex-page .sidebar {
  background-color: #5b9452; 
}

/* Change text color in the sidebar */
.flex-page .sidebar, .flex-page .sidebar h1, .flex-page .sidebar h2, .flex-page .sidebar h3 {
  color: #FFFFFF;
}
</style>
## Sidebar {.sidebar data-width=400}
------------------------------------------------------

Column  {.tabset .tabset-fade}
-----------------------------------------------------------------------
### Air Yards vs. Yards After Catch (YAC)
```{r}
knitr::include_graphics("AIR_YAC_yards_25.png")
```

### Explosive Plays
```{r}
knitr::include_graphics("exp_play_wrs.png")
```

### Fantasy Variability
```{r}
knitr::include_graphics("fantasy_vars_wrs.png")
```

### Receiver Updated Stats
```{r}
season_player_stats <- nflreadr::load_player_stats(
  seasons = 2025,
  summary_level = "reg", 
)

wr_season_stats <- season_player_stats %>%
  filter(position == "WR" | position == "TE" | position == "RB") %>%
  select(player_id,
         player_name,
         player_display_name,
         games,
         receptions,
         targets,
         target_share, 
         receiving_yards,
         receiving_tds,
         receiving_yards_after_catch,
         receiving_air_yards,
         receiving_first_downs,
         receiving_epa,
         target_share,
         wopr,
         racr,
         air_yards_share,
         fantasy_points_ppr) %>%
  mutate(target_share = round(100* target_share,2),
         air_yards_share = round(100 * air_yards_share,2)) %>%
  filter(targets >= 10) %>%
  arrange(-receiving_yards)

wr_season_stats <- wr_season_stats %>%
  select(player_display_name,
         games,
         receptions,
         targets,
         target_share,
         receiving_yards,
         receiving_tds,
         receiving_air_yards,
         receiving_yards_after_catch,
         receiving_first_downs,
         receiving_epa,
         air_yards_share,
         fantasy_points_ppr
         ) %>% 
  mutate(receiving_epa = round(receiving_epa,2),
    ypg = round(receiving_yards/games),2)

wr_season_stats <- wr_season_stats %>%
  select(player_display_name,
         games,
         receptions,
         targets,
         target_share,
         receiving_yards,
         ypg,
         receiving_tds,
         receiving_air_yards,
         receiving_yards_after_catch,
         receiving_first_downs,
         receiving_epa,
         air_yards_share,
         fantasy_points_ppr
         )
colnames(wr_season_stats) <- c("Player Name", "Games", "Catches", "Targets",
                              "Target Share", "Receiving Yards", "YPG", "TDs",
                              "Air Yards", "YAC", "First Downs", "Total EPA",
                              "Air Yards Share")


datatable(wr_season_stats, filter = 'top', options = list(pageLength = 25))
```


Quarterbacks
===============================
<style>
/* Change sidebar background color */
.flex-page .sidebar {
  background-color: #5b9452; 
}

/* Change text color in the sidebar */
.flex-page .sidebar, .flex-page .sidebar h1, .flex-page .sidebar h2, .flex-page .sidebar h3 {
  color: #FFFFFF;
}
</style>
## Sidebar {.sidebar data-width=400}
------------------------------------------------------

Column {.tabset .tabset-fade}
-----------------------------------------------------------------------
### QB Rating and On Target Throw %
```{r}
knitr::include_graphics("qbr_ontgt.png")
```

### Bad Throw % and Pressure Rate
```{r}
knitr::include_graphics("bad_throw_pressure.png")
```

### Average Depth of Target (ADOT)
```{r}
knitr::include_graphics("qb_comp_pct_air_yds.png")
```

### On Target Throws vs. Drop Percentage
```{r}
knitr::include_graphics("on_target_drops.png")
```

Teams
==============================
<style>
/* Change sidebar background color */
.flex-page .sidebar {
  background-color: #5b9452; 
}

/* Change text color in the sidebar */
.flex-page .sidebar, .flex-page .sidebar h1, .flex-page .sidebar h2, .flex-page .sidebar h3 {
  color: #FFFFFF;
}
</style>
## Sidebar {.sidebar data-width=400}
------------------------------------------------------

Column {.tabset .tabset-fade}
-----------------------------------------------------------------------
### Offensive and Defensive EPA Per Play
```{r}
knitr::include_graphics("off-def-EPA-25.png")
```

### Offensive and Defensive Yards Per Play
```{r}
knitr::include_graphics("off-def-YPP-25.png")
```

### Updated Strength of Schedule and Team Stats Table
```{r}
# Load libraries
library(nflfastR)
library(dplyr)
library(tidyr)
library(stringr)

pbp <- load_pbp(2025)  # or use multiple seasons: load_pbp(2022:2024)


# Offensive metrics
offense_summary <- pbp %>%
  filter(!is.na(posteam)) %>%
  group_by(season, posteam, game_id) %>%
  summarise(
    points = max(posteam_score_post, na.rm = TRUE) - min(posteam_score, na.rm = TRUE),
    yards = sum(yards_gained, na.rm = TRUE),
    plays = n(),
    epa = mean(epa, na.rm = TRUE),
    turnovers = sum(interception == 1 | fumble_lost == 1, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  group_by(season, posteam) %>%
  summarise(
    games_played = n(),
    total_points = sum(points),
    total_yards = sum(yards),
    total_turnovers = sum(turnovers),
    epa_per_play_off = mean(epa, na.rm = TRUE),
    ypg = total_yards / games_played,
    ppg = total_points / games_played,
    .groups = "drop"
  )

# Defensive metrics
defense_summary <- pbp %>%
  filter(!is.na(defteam)) %>%
  group_by(season, defteam, game_id) %>%
  summarise(
    yards_allowed = sum(yards_gained, na.rm = TRUE),
    points_allowed = max(posteam_score_post, na.rm = TRUE) - min(posteam_score, na.rm = TRUE),
    epa_allowed = mean(epa, na.rm = TRUE),
    takeaways = sum(interception == 1 | fumble_lost == 1, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  group_by(season, defteam) %>%
  summarise(
    games_played = n(),
    total_yards_allowed = sum(yards_allowed),
    total_points_allowed = sum(points_allowed),
    total_takeaways = sum(takeaways),
    epa_per_play_def = mean(epa_allowed, na.rm = TRUE),
    ypg_allowed = total_yards_allowed / games_played,
    ppg_allowed = total_points_allowed / games_played,
    .groups = "drop"
  ) %>%
  rename(posteam = defteam)

#W/L
games <- pbp %>%
  filter(!is.na(home_team), !is.na(away_team)) %>%
  group_by(season, game_id, home_team, away_team) %>%
  summarise(
    home_score = max(posteam_score_post[posteam == home_team], na.rm = TRUE),
    away_score = max(posteam_score_post[posteam == away_team], na.rm = TRUE),
    home_win = home_score > away_score,
    away_win = away_score > home_score,
    .groups = "drop"
  )


team_records <- games %>%
  select(season, home_team, away_team, home_win, away_win) %>%
  pivot_longer(cols = c(home_team, away_team), names_to = "venue", values_to = "team") %>%
  mutate(win = ifelse((venue == "home_team" & home_win) | (venue == "away_team" & away_win), 1, 0)) %>%
  group_by(season, team) %>%
  summarise(
    wins = sum(win, na.rm = TRUE),
    games_played = n(),
    losses = games_played - wins,
    win_pct = wins / games_played,
    .groups = "drop"
  ) %>%
  rename(posteam = team)

#----------------------------------
# 4. Compute Strength of Schedule (opponent records)
#----------------------------------

games$away_team

# Create one row per teamâ€“opponent pair for every game
sos_raw <- games %>%
  select(season, home_team, away_team) %>%
  # Home perspective
  mutate(posteam = home_team,
         opponent = away_team) %>%
  select(season, posteam, opponent) %>%
  bind_rows(
    # Away perspective
    games %>%
      select(season, home_team, away_team) %>%
      mutate(posteam = away_team,
             opponent = home_team) %>%
      select(season, posteam, opponent)
  )

# Combine with opponent win% to compute average opponent win%
sos <- sos_raw %>%
  left_join(team_records %>% select(season, posteam, opp_win_pct = win_pct),
            by = c("season", "opponent" = "posteam")) %>%
  group_by(season, posteam) %>%
  summarise(
    avg_opp_win_pct = mean(opp_win_pct, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    # Rank 1 = hardest schedule (highest avg opponent win%)
    sos_rank = rank(-avg_opp_win_pct, ties.method = "first")
  )

team_summary <- offense_summary %>%
  left_join(defense_summary, by = c("season", "posteam")) %>%
  left_join(team_records, by = c("season", "posteam")) %>%
  left_join(sos, by = c("season", "posteam")) %>%
  mutate(
    turnover_diff = total_takeaways - total_turnovers,
    net_epa_per_play = epa_per_play_off - epa_per_play_def,
    net_yard_diff = ypg - ypg_allowed,
    net_point_diff = ppg - ppg_allowed
  ) %>%
  arrange(season, desc(net_point_diff))

team_summary <- team_summary %>%
  select(season, posteam, wins, losses, sos_rank, 
         ppg, ppg_allowed, ypg, ypg_allowed,
         epa_per_play_off, epa_per_play_def,
         turnover_diff, net_point_diff, net_epa_per_play) %>%
  arrange(wins, sos_rank)



datatable(team_summary, filter = 'top', options = list(pageLength = 32))

```

